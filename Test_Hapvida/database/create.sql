
-- ESQUEMA CRIADO NO ORACLE 21C, BANCO XEPDB1

-- Tabela de clientes (CORRIGIDA)
CREATE TABLE TB_CLIENTE (
  ID_CLIENTE      NUMBER         NOT NULL,
  NOME            VARCHAR2(80)  NOT NULL,
  EMAIL           VARCHAR2(50),
  CEP             VARCHAR2(8),
  LOGRADOURO      VARCHAR2(100),
  BAIRRO          VARCHAR2(100),
  CIDADE          VARCHAR2(100),
  UF              VARCHAR2(2),
  ATIVO           NUMBER(1)      DEFAULT 1 NOT NULL,
  DT_CRIACAO      DATE           DEFAULT SYSTIMESTAMP NOT NULL,
  DT_ATUALIZACAO  DATE,
  --
  CONSTRAINT pk_cliente PRIMARY KEY (ID_CLIENTE),
  CONSTRAINT uk_cliente_email UNIQUE (EMAIL),
  CONSTRAINT chk_cliente_ativo CHECK (ATIVO IN (0,1)),
  CONSTRAINT chk_cliente_uf CHECK (UF IN (
    'AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG',
    'PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'
  ))
);

-- √çndice
CREATE INDEX idx_cliente_nome ON TB_CLIENTE(NOME);

-- Sequence
CREATE SEQUENCE SEQ_CLIENTE
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Tabela de log (opcional)
CREATE TABLE TB_LOG_ERRO (
  ID_LOG    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  DT_EVENTO  DATE DEFAULT SYSTIMESTAMP NOT NULL,
  USUARIO   VARCHAR2(30),
  ORIGEM    VARCHAR2(30),
  MENSAGEM  VARCHAR2(4000),
  --
  CONSTRAINT pk_log_erro PRIMARY KEY (ID_LOG)
);

-- Trigger (CORRIGIDO)
CREATE OR REPLACE TRIGGER TRG_CLIENTE_BI
BEFORE INSERT OR UPDATE ON TB_CLIENTE
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        IF :NEW.ID_CLIENTE IS NULL THEN
            :NEW.ID_CLIENTE := SEQ_CLIENTE.NEXTVAL;
        END IF;
		
		IF :NEW.DT_CRIACAO IS NULL THEN
            :NEW.DT_CRIACAO := SYSTIMESTAMP;
        END IF;
		
        :NEW.ATIVO := NVL(:NEW.ATIVO, 1);
    END IF;
    
    IF UPDATING THEN
        :NEW.DT_ATUALIZACAO := SYSTIMESTAMP;
    END IF;
END;
/



